<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ðŸ“Š Dashboard with Calendar</title>

  <!-- âœ… FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background:#f9fafc;
      margin:0; padding:20px;
    }
    .container { max-width: 1000px; margin:auto; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .summary { display:flex; gap:20px; margin-bottom:20px; }
    .card {
      flex:1; background:#fff; padding:15px; text-align:center;
      border-radius:8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .card h2 { margin:0; font-size:2em; }
    #calendar {
      max-width: 900px;
      margin: 20px auto;
      background: #fff;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      min-height: 600px;
    }
    #jobList { margin-top:20px; }
    .job {
      background:#fff; padding:10px; margin-bottom:10px;
      border-radius:6px; border:1px solid #ddd;
    }
    .job button {
      margin-top:8px; background:#4a4aff; color:#fff; border:none;
      padding:6px 10px; border-radius:4px; cursor:pointer;
    }
    /* âœ… Modal */
    .modal {
      display:none; position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.5); justify-content:center; align-items:center;
    }
    .modal-content {
      background:#fff; padding:20px; border-radius:8px; max-width:400px; width:90%;
    }
    .modal-content h3 { margin-top:0; }
    .modal-content input, .modal-content textarea {
      width:100%; margin-bottom:10px; padding:8px;
      border:1px solid #ccc; border-radius:4px;
    }
    .modal-content button { margin-right:8px; }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>ðŸ“Š Dashboard</h1>
    <button id="logoutBtn" style="background:#ff4d4d; color:#fff; border:none; padding:8px 12px; border-radius:5px; cursor:pointer;">
      Logout
    </button>
  </header>

  <!-- Summary cards -->
  <div class="summary">
    <div class="card">
      <h2 id="emailCount">0</h2>
      <p>Emails Scheduled</p>
    </div>
    <div class="card">
      <h2 id="smsCount">0</h2>
      <p>SMS Scheduled</p>
    </div>
  </div>

  <!-- Calendar -->
  <h2>ðŸ“… Schedule Overview</h2>
  <div id="calendar"></div>

  <!-- Job List -->
  <h2>ðŸ“‹ Upcoming Jobs</h2>
  <div id="jobList"></div>
</div>

<!-- âœ… Edit Modal -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <h3>Edit Job</h3>
    <input type="text" id="editTo" placeholder="Recipient"/>
    <input type="datetime-local" id="editDatetime"/>
    <textarea id="editBody" rows="4" placeholder="Message body / Subject"></textarea>
    <div>
      <button id="saveJobBtn">Save</button>
      <button onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
let jobs = [];
let calendar;
let editingJobId = null;

document.addEventListener("DOMContentLoaded", async function () {
  await fetchJobs();
});

// âœ… Fetch jobs from server
async function fetchJobs() {
  try {
    const res = await fetch("/api/jobs");
    const data = await res.json();
    jobs = data.jobs || [];

    // update counts
    document.getElementById("emailCount").innerText = jobs.filter(j => j.method==="email").length;
    document.getElementById("smsCount").innerText = jobs.filter(j => j.method==="sms").length;

    renderCalendar();
    renderJobList();
  } catch(err) {
    console.error(err);
    alert("Failed to load jobs");
  }
}

// âœ… Render calendar with jobs
function renderCalendar() {
  const events = jobs.map(job => ({
    id: job._id,
    title: (job.method==="email" ? "ðŸ“§ " : "ðŸ“± ") + (job.subject || job.body || job.to),
    start: job.datetime
  }));
  if(!calendar) {
    calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
      initialView: "dayGridMonth",
      events: events,
      eventClick: (info)=> openEditModal(info.event.id)
    });
    calendar.render();
  } else {
    calendar.removeAllEvents();
    calendar.addEventSource(events);
  }
}

// âœ… Render job list
function renderJobList() {
  const list = document.getElementById("jobList");
  list.innerHTML = "";
  jobs.forEach(job=>{
    const div = document.createElement("div");
    div.className="job";
    div.innerHTML = `
      <strong>${job.method.toUpperCase()}</strong> â†’ ${job.to}<br/>
      At: ${new Date(job.datetime).toLocaleString()}<br/>
      ${job.subject ? "Subject: "+job.subject : job.body || ""}<br/>
      <button onclick="openEditModal('${job._id}')">Edit</button>
    `;
    list.appendChild(div);
  });
}

// âœ… Open modal for editing
function openEditModal(id) {
  const job = jobs.find(j => j._id===id || j.id===id);
  if(!job) return;
  editingJobId = job._id || job.id;

  document.getElementById("editTo").value = job.to || "";
  document.getElementById("editDatetime").value = job.datetime ? job.datetime.slice(0,16) : "";
  document.getElementById("editBody").value = job.subject || job.body || "";

  document.getElementById("editModal").style.display="flex";
}
function closeModal() {
  document.getElementById("editModal").style.display="none";
}

// âœ… Save edited job
document.getElementById("saveJobBtn").addEventListener("click", async ()=>{
  if(!editingJobId) return;

  const payload = {
    to: document.getElementById("editTo").value,
    datetime: new Date(document.getElementById("editDatetime").value).toISOString(),
    body: document.getElementById("editBody").value,
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
  };

  try {
    const res = await fetch(`/api/jobs/${editingJobId}`, {
      method:"PUT",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });
    const result = await res.json();
    alert(result.message || "Updated");

    closeModal();
    fetchJobs();
  } catch(err) {
    console.error(err);
    alert("Failed to update job");
  }
});
</script>
</body>
</html>
