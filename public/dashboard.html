<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>üìä Dashboard</title>

<!-- FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css  " rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js  "></script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f9fafc;
  margin:0; padding:0;
  display:flex;
  height:100vh;
  overflow: hidden; /* Prevent scrollbars during transition */
}

/* Sidebar */
.sidebar {
  width:220px;
  background:#222;
  color:white;
  display:flex;
  flex-direction:column;
  padding:20px 0;
  transition: width 0.3s; /* Smooth transition for collapse */
  position: relative; /* Ensure toggle button can be positioned relative to this if needed */
  z-index: 10; /* Ensure sidebar is above main content during collapse */
}
.sidebar h2 {
  text-align:center;
  margin-bottom:30px;
  color:#4a90e2;
}
.sidebar a {
  padding:12px 20px;
  text-decoration:none;
  color:white;
  display:block;
}
.sidebar a:hover, .sidebar a.active {
  background:#4a90e2;
  cursor:pointer;
}
.sidebar button {
  margin:20px;
  padding:10px;
  border:none;
  border-radius:5px;
  background:#ff4d4d;
  color:white;
  cursor:pointer;
}

/* Toggle button - Positioned to the LEFT of the EXPANDED sidebar */
.toggle-btn {
  position: absolute;
  top: 15px;
  left: 230px; /* Position it to the right of the expanded sidebar (220px width + some padding) */
  background: #4a4aff;
  color: white;
  border: none;
  border-radius: 0 5px 5px 0; /* Rounded on the right side only */
  padding: 8px 10px;
  cursor: pointer;
  z-index: 101; /* Ensure it's above both sidebar and main content */
  transition: left 0.3s; /* Smooth transition when sidebar collapses */
}

/* Adjust toggle button position when sidebar is collapsed */
.sidebar.collapsed ~ .main .toggle-btn {
  left: 60px; /* Position it to the right of the collapsed sidebar (60px width) */
}

/* Collapsed sidebar */
.sidebar.collapsed {
  width: 60px;
}
.sidebar.collapsed h2,
.sidebar.collapsed a span, /* Assuming links use <span> for text */
.sidebar.collapsed button span { /* Assuming button uses <span> for text */
  display: none; /* Hide text when collapsed */
}
.sidebar.collapsed a {
  text-align: center;
  padding: 15px 0; /* Adjust padding for centering */
}
.sidebar.collapsed button {
  margin: 15px 10px; /* Adjust margin */
  padding: 10px; /* Adjust padding */
}

.main {
  flex:1;
  padding:20px;
  overflow-y:auto;
  transition: margin-left 0.3s; /* Smooth transition when sidebar collapses */
  position: relative; /* Ensure it can contain the toggle button if needed */
}

.main.shifted { /* Class to shift main content when sidebar is collapsed */
  margin-left: 60px; /* Match the collapsed sidebar width */
}

/* Summary cards */
.summary { display:flex; gap:20px; margin-bottom:20px; flex-wrap:wrap; }
.card {
  flex:1; min-width:150px;
  background:#fff; padding:15px; text-align:center;
  border-radius:8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.card h2 { margin:0; font-size:2em; }

/* Calendar */
#calendar {
  max-width: 900px;
  margin: 20px auto;
  background:#fff;
  padding: 10px;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
  min-height:600px;
}

/* Job cards */
#jobList { margin-top:20px; }
.job {
  background:#fff;
  padding:10px;
  margin-bottom:10px;
  border-radius:6px;
  border:1px solid #ddd;
}
.job button {
  margin-top:8px;
  background:#4a4aff;
  color:#fff;
  border:none;
  padding:6px 10px;
  border-radius:4px;
  cursor:pointer;
}

/* Modal */
.modal {
  display:none; position:fixed; top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.5);
  justify-content:center; align-items:center;
  z-index: 1000; /* Ensure modal is above everything */
}
.modal-content {
  background:#fff; padding:20px; border-radius:8px; max-width:400px; width:90%;
}
.modal-content h3 { margin-top:0; }
.modal-content input, .modal-content textarea {
  width:100%; margin-bottom:10px; padding:8px;
  border:1px solid #ccc; border-radius:4px;
}
</style>
</head>
<body>

<!-- Toggle button - MOVED OUTSIDE the sidebar div -->
<button class="toggle-btn" id="toggleSidebar">‚ò∞</button>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <!-- Removed the toggle button from here -->
  <h2>Scheduler</h2>
  <a href="/dashboard.html" class="active"><span>üìä Dashboard</span></a> <!-- Wrapped text in <span> -->
  <a href="/schedule"><span>‚è∞ Schedule</span></a> <!-- Wrapped text in <span> -->
  <button id="logoutBtn"><span>Logout</span></button> <!-- Wrapped text in <span> -->
</div>

<!-- Main content -->
<div class="main" id="main">
  <h1>üìä Dashboard</h1>

  <!-- Summary -->
  <div class="summary">
    <div class="card">
      <h2 id="emailCount">0</h2>
      <p>Emails Scheduled</p>
    </div>
  <div class="card">
    <h2 id="smsCount">0</h2>
    <p>SMS Scheduled</p>
  </div>
  </div>

  <!-- Calendar -->
  <h2>üìÖ Schedule Overview</h2>
  <div id="calendar"></div>

  <!-- Job list -->
  <h2>üìã Upcoming Jobs</h2>
  <div id="jobList"></div>
</div>

<!-- Edit Modal -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <h3>Edit Job</h3>
    <input type="text" id="editTo" placeholder="Recipient"/>
    <input type="datetime-local" id="editDatetime"/>
    <textarea id="editBody" rows="4" placeholder="Message body / Subject"></textarea>
    <div>
      <button id="saveJobBtn">Save</button>
      <button onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js  ";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js  ";

// Firebase Config (same as login)
const firebaseConfig = {
  apiKey: "AIzaSyAcNhqW9wkLs3S7O5bp4GMJ0SWJ4d-7GRo",
  authDomain: "email-scheduler-80501.firebaseapp.com",
  projectId: "email-scheduler-80501",
  storageBucket: "email-scheduler-80501.appspot.com",
  messagingSenderId: "357118084169",
  appId: "1:357118084169:web:1140c0a3f67f0e9bdfeb98",
  measurementId: "G-96971SLQXH"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

let jobs = [];
let calendar;
let editingJobId = null;

// Fetch jobs
async function fetchJobs() {
  const token = await auth.currentUser.getIdToken();
  const res = await fetch("/api/jobs", {
    headers: { Authorization: `Bearer ${token}` }
  });
  const data = await res.json();
  jobs = data.jobs || [];

  document.getElementById("emailCount").innerText = data.counts?.email ?? 0;
  document.getElementById("smsCount").innerText = data.counts?.sms ?? 0;

  renderCalendar();
  renderJobList();
}

// Calendar
function renderCalendar() {
  const events = jobs.map(job=>({
    id: job._id,
    title: (job.method==="email" ? "üìß " : "üì± ")+(job.subject || job.body || job.to),
    start: job.datetime
  }));
  if(!calendar) {
    calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
      initialView:"dayGridMonth",
      events,
      eventClick:(info)=>openEditModal(info.event.id)
    });
    calendar.render();
  } else {
    calendar.removeAllEvents();
    calendar.addEventSource(events);
  }
}

// Job List
function renderJobList() {
  const list = document.getElementById("jobList");
  list.innerHTML="";
  jobs.forEach(job=>{
    if(job.status!=="scheduled") return;
    const div=document.createElement("div");
    div.className="job";
    div.innerHTML=`
      <strong>${job.method.toUpperCase()}</strong> ‚Üí ${job.to}<br/>
      At: ${new Date(job.datetime).toLocaleString()}<br/>
      ${job.subject ? "Subject: "+job.subject : job.body || ""}<br/>
      <button onclick="openEditModal('${job._id}')">Edit</button>
    `;
    list.appendChild(div);
  });
}

// Modal open/close
window.openEditModal=function(id){
  const job=jobs.find(j=>j._id===id);
  if(!job) return;
  editingJobId=id;
  document.getElementById("editTo").value=job.to||"";
  document.getElementById("editDatetime").value=job.datetime?job.datetime.slice(0,16):"";
  document.getElementById("editBody").value=job.subject||job.body||"";
  document.getElementById("editModal").style.display="flex";
};
window.closeModal=function(){
  document.getElementById("editModal").style.display="none";
}

// Save edit
document.getElementById("saveJobBtn").addEventListener("click",async()=>{
  if(!editingJobId) return;
  const payload={
    to:document.getElementById("editTo").value,
    datetime:new Date(document.getElementById("editDatetime").value).toISOString(),
    body:document.getElementById("editBody").value,
    timezone:Intl.DateTimeFormat().resolvedOptions().timeZone
  };
  const token=await auth.currentUser.getIdToken();
  const res=await fetch(`/api/jobs/${editingJobId}`,{
    method:"PUT",
    headers:{"Content-Type":"application/json","Authorization":`Bearer ${token}`},
    body:JSON.stringify(payload)
  });
  const result=await res.json();
  alert(result.message||result.error);
  closeModal();
  fetchJobs();
});

// Auth guard
onAuthStateChanged(auth,(user)=>{
  if(!user){
    window.location.href="/";
  }else{
    fetchJobs();
  }
});

// Logout
document.getElementById("logoutBtn").addEventListener("click",async()=>{
  await signOut(auth);
  window.location.href="/";
});

// --- Sidebar Toggle Functionality ---
document.getElementById('toggleSidebar').addEventListener('click', ()=>{
  const sidebar = document.getElementById('sidebar');
  const main = document.getElementById('main');
  sidebar.classList.toggle('collapsed');
  main.classList.toggle('shifted');
});
// --- End Sidebar Toggle ---
</script>
</body>
</html>
