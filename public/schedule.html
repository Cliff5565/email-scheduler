<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>‚è∞ Schedule Notification</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f9fafc;
  margin: 0;
  padding: 0;
  display: flex;
  height: 100vh;
}

/* Sidebar */
.sidebar {
  width:220px;
  background:#222;
  color:white;
  display:flex;
  flex-direction:column;
  padding:20px 0;
}
.sidebar h2 {
  text-align:center;
  margin-bottom:30px;
  color:#4a90e2;
}
.sidebar a {
  padding:12px 20px;
  text-decoration:none;
  color:white;
  display:block;
}
.sidebar a:hover, .sidebar a.active {
  background:#4a90e2;
  cursor:pointer;
}
.sidebar button {
  margin:20px;
  padding:10px;
  border:none;
  border-radius:5px;
  background:#ff4d4d;
  color:white;
  cursor:pointer;
}

/* Main */
.main {
  flex:1;
  padding:20px;
  overflow-y:auto;
}

.container {
  max-width: 600px;
  margin: 20px auto;
  padding: 20px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

header {
  margin-bottom: 20px;
  border-bottom: 1px solid #eee;
  padding-bottom: 10px;
}

.user-info {
  color: #555;
  font-size: 14px;
}

input, textarea, select {
  width: 100%;
  padding: 12px;
  margin: 10px 0;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 14px;
}

button.submit-btn {
  width: 100%;
  padding: 12px;
  background: #4a4aff;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  margin-top: 15px;
}
button.submit-btn:disabled {
  background: #ccc;
  cursor: not-allowed;
}

#result {
  margin-top: 15px;
  padding: 12px;
  border-radius: 6px;
  display: none;
}
.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
</style>
</head>
<body>
<!-- Sidebar -->
<div class="sidebar">
  <h2>Scheduler</h2>
  <a href="/dashboard.html">üìä Dashboard</a>
  <a href="/schedule" class="active">‚è∞ Schedule</a>
  <button id="logoutBtn">Logout</button>
</div>

<!-- Main -->
<div class="main">
  <div class="container">
    <header>
      <h1>Schedule a Notification</h1>
      <div><span id="user-status" class="user-info">Loading...</span></div>
    </header>

    <!-- Method -->
    <label for="method">Choose Method:</label>
    <select id="method">
      <option value="email" selected>Email</option>
      <option value="sms">SMS</option>
    </select>

    <input type="text" id="to" placeholder="Recipient (email or phone)" required />
    <input type="text" id="subject" placeholder="Subject (only for email)" />
    <textarea id="body" rows="5" placeholder="Message text" required></textarea>

    <label for="file">Attach a File (optional):</label>
    <input type="file" id="file" />

    <label for="datetime">Schedule Time:</label>
    <input type="datetime-local" id="datetime" required />

    <div id="timezone-display"></div>

    <button class="submit-btn" id="scheduleBtn" disabled>Schedule</button>
    <div id="result"></div>
  </div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAcNhqW9wkLs3S7O5bp4GMJ0SWJ4d-7GRo",
  authDomain: "email-scheduler-80501.firebaseapp.com",
  projectId: "email-scheduler-80501",
  storageBucket: "email-scheduler-80501.appspot.com",
  messagingSenderId: "357118084169",
  appId: "1:357118084169:web:1140c0a3f67f0e9bdfeb98",
  measurementId: "G-96971SLQXH"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// Pre-fill date
const now = new Date();
const pad = n => String(n).padStart(2,'0');
document.getElementById('datetime').value =
`${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;

// Show timezone
const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
document.getElementById('timezone-display').textContent = `Your timezone: ${timezone}`;

function updateUserStatus(user) {
  const statusEl = document.getElementById('user-status');
  const scheduleBtn = document.getElementById('scheduleBtn');
  if (user) {
    statusEl.textContent = `Logged in as: ${user.email}`;
    scheduleBtn.disabled = false;
  } else {
    statusEl.textContent = 'Not logged in';
    scheduleBtn.disabled = true;
    window.location.href = "/";
  }
}
onAuthStateChanged(auth, updateUserStatus);

// Logout
document.getElementById('logoutBtn').addEventListener('click', async()=>{
  try {
    if(auth.currentUser){
      const token = await auth.currentUser.getIdToken();
      await fetch('/api/logout',{
        method:'POST',
        headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}
      });
    }
    await signOut(auth);
    window.location.href="/";
  }catch(err){
    alert("Logout failed: "+err.message);
  }
});

// Schedule
document.getElementById('scheduleBtn').addEventListener('click', async()=>{
  const method=document.getElementById('method').value;
  const to=document.getElementById('to').value.trim();
  const subject=document.getElementById('subject').value.trim();
  const body=document.getElementById('body').value.trim();
  const localDateTime=document.getElementById('datetime').value;
  const file=document.getElementById('file').files[0];

  if(!to||!body||!localDateTime){ showError("Please fill required fields."); return; }
  if(!auth.currentUser){ showError("Not logged in."); return; }

  try {
    const idToken=await auth.currentUser.getIdToken();
    const payload={method,to,subject:method==="email"?subject:undefined,body,datetime:localDateTime,timezone};

    let res;
    if(file){
      const formData=new FormData();
      formData.append("file",file);
      formData.append("data",JSON.stringify(payload));
      res=await fetch('/api/schedule',{method:'POST',headers:{Authorization:`Bearer ${idToken}`},body:formData});
    }else{
      res=await fetch('/api/schedule',{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':`Bearer ${idToken}`},
        body:JSON.stringify(payload)
      });
    }
    const result=await res.json();
    showMessage(result.message||result.error,res.ok);
  }catch(err){ showError("Network error: "+err.message); }
});

function showMessage(msg,success){
  const div=document.getElementById('result');
  div.className=success?'success':'error';
  div.textContent=msg;
  div.style.display='block';
}
function showError(msg){ showMessage(msg,false); }
</script>
</body>
</html>
