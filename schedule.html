<script>
  // Firebase config (same as in index.html)
  const firebaseConfig = {
    apiKey: "AIzaSyAcNhqW9wkLs3S7O5bp4GMJ0SWJ4d-7GRo",
    authDomain: "email-scheduler-80501.firebaseapp.com",
    projectId: "email-scheduler-80501",
    storageBucket: "email-scheduler-80501.firebasestorage.app",
    messagingSenderId: "357118084169",
    appId: "1:357118084169:web:1140c0a3f67f0e9bdfeb98",
    measurementId: "G-96971SLQXH"
  };

  // Initialize Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, getIdToken } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // Auto-fill datetime with current date/time in user's local time
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const hour = String(now.getHours()).padStart(2, '0');
  const minute = String(now.getMinutes()).padStart(2, '0');
  document.getElementById('datetime').value = `${year}-${month}-${day}T${hour}:${minute}`;

  // Show detected timezone
  const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
  document.getElementById('timezone-display').textContent = `Your timezone: ${timezone}`;

  // ðŸ‘‡ CRITICAL: Wait for user to be authenticated before allowing form use
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      // User is not signed in â€” redirect to login
      console.log("âŒ Not authenticated, redirecting to login...");
      window.location.href = "/";
      return;
    }

    console.log("âœ… User authenticated:", user.email);

    // âœ… Now itâ€™s safe to enable the form and make API calls
    document.getElementById('scheduleBtn').disabled = false;
  });

  // Schedule button handler
  document.getElementById('scheduleBtn').addEventListener('click', async () => {
    const to = document.getElementById('to').value.trim();
    const subject = document.getElementById('subject').value.trim();
    const body = document.getElementById('body').value.trim();
    const localDateTime = document.getElementById('datetime').value;

    if (!to || !subject || !body || !localDateTime) {
      showError("Please fill all fields.");
      return;
    }

    const dt = new Date(localDateTime);
    const utcString = dt.toISOString();

    try {
      // ðŸ‘‡ GET ID TOKEN FROM FIREBASE AUTH AND SEND IT WITH REQUEST
      const idToken = await getIdToken(auth.currentUser);

      const response = await fetch('/schedule', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${idToken}` // ðŸ‘ˆ THIS IS THE FIX!
        },
        body: JSON.stringify({
          to,
          subject,
          body,
          datetime: utcString,
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
        })
      });

      const result = await response.json();

      const resultDiv = document.getElementById('result');
      resultDiv.className = response.ok ? 'success' : 'error';
      resultDiv.textContent = result.message || result.error;
      resultDiv.style.display = 'block';

      if (response.ok) {
        document.getElementById('to').value = '';
        document.getElementById('subject').value = '';
        document.getElementById('body').value = '';
        document.getElementById('datetime').value = `${year}-${month}-${day}T${hour}:${minute}`;
      }

    } catch (err) {
      console.error("API Error:", err);
      showError("Network error: " + err.message);
    }
  });

  function showError(msg) {
    const resultDiv = document.getElementById('result');
    resultDiv.className = 'error';
    resultDiv.textContent = msg;
    resultDiv.style.display = 'block';
  }
</script>
